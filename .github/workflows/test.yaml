name: Go Test

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    # Service containers to run with `runner-job`
    services:
      docker:
        image: docker:20.10.3-dind
        options: --privileged --publish 2375:2375 --env DOCKER_TLS_CERTDIR=""
        ports:
          - 2375:2375

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.18
      - name: Install dependencies
        run: go mod download
      - name: Run tests
        env:
          DOCKER_HOST: tcp://docker:2375
          DOCKER_DRIVER: overlay2
          YOUR_APP_DB_HOST: docker
        run: go test -v -count=1 $(go list ./... | grep -v /vendor/)
